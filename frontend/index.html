<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Toy Shop</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #04ad56; color: #333; }
    h1, h2 { text-align: center; color: #fff; }
    button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .toggle-btns { text-align: center; margin-bottom: 20px; }
    .toy-card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
    .toy-card img { width: 100%; max-height: 160px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; }
    #toy-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
    .toy-card button { background: #0077cc; color: #fff; }
    .toy-card button:hover { background: #005fa3; }
    #cart { background: #fff; padding: 20px; border-radius: 12px; margin-top: 40px; }
    #cart div { display: flex; justify-content: space-between; margin-bottom: 8px; }
    #cart button { background: #cc0000; color: #fff; padding: 4px 10px; }
    #cart button:hover { background: #a60000; }
    form { background: #fff; padding: 20px; border-radius: 10px; display: flex;flex-direction: column; max-width:400px;gap: 10px; flex-wrap: wrap; margin-top: 30px;margin: 30px auto; }
    form input, form button {  padding: 10px 14px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box; }
    .user-info { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .logout-btn { background: #ff4444; color: #fff; margin-left: 10px; }
    .logout-btn:hover { background: #cc0000; }
    .auth-section { display: none; }
    .auth-section.active { display: block; }
  </style>
</head>
<body>

  <div class="toggle-btns">
    <button onclick="showSection('shop')" id="shopBtn" style="display: none;">üè™ Toy Shop</button>
    <button onclick="showSection('login')" id="loginBtn">üîê Login</button>
    <button onclick="showSection('register')" id="registerBtn">üë§ Register</button>
  </div>

  <!-- User Info Section (shown when logged in) -->
  <div id="userInfo" class="user-info" style="display: none;">
    <h3>Welcome, <span id="userName"></span>!</h3>
    <p>Email: <span id="userEmail"></span></p>
    <button onclick="logout()" class="logout-btn">Logout</button>
  </div>

  <!-- Toy Shop Section -->
  <div id="shopSection" class="auth-section">
    <h1>Welcome to the Toy Shop</h1>
    <div id="toy-list"></div>

    <div id="cart"><h2>üõí Cart</h2><p>Your cart is empty.</p></div>

    <h2>Add New Toy</h2>
    <form id="toyForm">
      <input name="name" placeholder="Toy Name" required>
      <input name="categoryId" placeholder="Category ID" required>
      <input name="price" type="number" placeholder="Price" step="0.01" required>
      <input name="image" type="url" placeholder="Image URL" required>
      <button type="submit">Add Toy</button>
    </form>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="auth-section active">
    <h2>üîê Login</h2>
    <form id="loginForm">
      <input name="email" type="email" placeholder="Email" required>
      <input name="password" type="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <p style="text-align: center; color: #fff; margin-top: 20px;">
      Don't have an account? <a href="#" onclick="showSection('register')" style="color: #fff; text-decoration: underline;">Register here</a>
    </p>
  </div>

  <!-- Register Section -->
  <div id="registerSection" class="auth-section">
    <h2>üë§ Register</h2>
    <form id="registerForm">
      <input name="name" placeholder="Name" required>
      <input name="email" type="email" placeholder="Email" required>
      <input name="password" type="password" placeholder="Password" required>
      <input name="address" placeholder="Address">
      <input name="phone" type="tel" placeholder="Phone">
      <button type="submit">Register</button>
    </form>
    <p style="text-align: center; color: #fff; margin-top: 20px;">
      Already have an account? <a href="#" onclick="showSection('login')" style="color: #fff; text-decoration: underline;">Login here</a>
    </p>
  </div>

  <script>
    // Global variables
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');
    const cart = [];

    // Check if user is already logged in
    if (authToken) {
      checkAuthStatus();
    } else {
      updateNavigationButtons(false);
    }

    // Authentication functions
    async function checkAuthStatus() {
      try {
        const response = await fetch('http://localhost:3000/api/profile', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          currentUser = user;
          showUserInfo();
          showSection('shop');
          updateNavigationButtons(true);
        } else {
          // Token is invalid, clear it
          localStorage.removeItem('authToken');
          authToken = null;
          currentUser = null;
          hideUserInfo();
          updateNavigationButtons(false);
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('authToken');
        authToken = null;
        currentUser = null;
        hideUserInfo();
        updateNavigationButtons(false);
      }
    }

    function showUserInfo() {
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    function hideUserInfo() {
      document.getElementById('userInfo').style.display = 'none';
      currentUser = null;
    }

    function updateNavigationButtons(isLoggedIn) {
      const shopBtn = document.getElementById('shopBtn');
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      
      if (isLoggedIn) {
        shopBtn.style.display = 'inline-block';
        loginBtn.style.display = 'none';
        registerBtn.style.display = 'none';
      } else {
        shopBtn.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        registerBtn.style.display = 'inline-block';
      }
    }

    function logout() {
      localStorage.removeItem('authToken');
      authToken = null;
      currentUser = null;
      hideUserInfo();
      updateNavigationButtons(false);
      showSection('login');
      alert('Logged out successfully!');
    }

    // Toggle Views
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.auth-section').forEach(el => {
        el.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(section + 'Section').classList.add('active');
    }

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('http://localhost:3000/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: formData.get('email'),
            password: formData.get('password')
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          showUserInfo();
          showSection('shop');
          updateNavigationButtons(true);
          this.reset();
          alert('Login successful!');
        } else {
          alert(data.error || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
      }
    });

    // Register form handler
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('http://localhost:3000/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: formData.get('name'),
            email: formData.get('email'),
            password: formData.get('password'),
            address: formData.get('address'),
            phone: formData.get('phone')
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          alert('Registration successful! Please login.');
          this.reset();
          showSection('login');
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
      }
    });

    // Cart functions
    const renderCart = () => {
      const cartDiv = document.getElementById('cart');
      if (!cart.length) return cartDiv.innerHTML = '<h2>üõí Cart</h2><p>Your cart is empty.</p>';

      cartDiv.innerHTML = '<h2>üõí Cart</h2>';
      cart.forEach((item, i) => {
        cartDiv.innerHTML += `<div>${item.name} ‚Äî ‚Çπ${item.price}<button onclick="removeFromCart(${i})">Remove</button></div>`;
      });
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      cartDiv.innerHTML += `<hr><strong>Total: ‚Çπ${total.toFixed(2)}</strong>`;
    };

    const removeFromCart = i => { cart.splice(i, 1); renderCart(); };
    const addToCart = toy => { cart.push(toy); alert(`${toy.name} added to cart`); renderCart(); };

    // Toy rendering
    const renderToys = toys => {
      const list = document.getElementById('toy-list');
      list.innerHTML = '';
      toys.forEach(toy => {
        list.innerHTML += `
          <div class="toy-card">
            <img src="${toy.image}" alt="${toy.name}">
            <h3>${toy.name}</h3>
            <p><strong>Price:</strong> ‚Çπ${toy.price}</p>
            <p><strong>Category:</strong> ${toy.categoryId}</p>
            <button onclick='addToCart(${JSON.stringify(toy)})'>Add to Cart</button>
            <button onclick='deleteToy("${toy._id}")' style="background:#cc0000; margin-left:8px;">Remove</button>
          </div>`;
      });
    };

    // Toy form handler
    document.getElementById('toyForm').addEventListener('submit', async e => {
      e.preventDefault();
      const f = new FormData(e.target);
      const toy = { name: f.get('name'), categoryId: f.get('categoryId'), price: +f.get('price'), image: f.get('image') };
      try {
        const res = await fetch('http://localhost:3000/api/toys', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(toy)
        });
        const data = await res.json();
        alert(`‚úÖ Toy "${data.name}" added!`);
        e.target.reset();
        const updated = await fetch('http://localhost:3000/api/toys').then(res => res.json());
        renderToys(updated);
      } catch (err) {
        alert('‚ùå Failed to add toy'); console.error(err);
      }
    });

    // Delete toy function
    async function deleteToy(id) {
      if (!confirm('Are you sure you want to delete this toy?')) return;

      try {
        const res = await fetch(`http://localhost:3000/api/toys/${id}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        alert(data.message || 'Toy deleted');
        
        // Refresh toy list
        const updated = await fetch('http://localhost:3000/api/toys').then(res => res.json());
        renderToys(updated);
      } catch (err) {
        alert('Failed to delete toy');
        console.error(err);
      }
    }

    // Load toys on page load
    fetch('http://localhost:3000/api/toys')
      .then(res => res.json())
      .then(data => renderToys(data))
      .catch(err => console.error('‚ùå Failed to fetch toys:', err));
  </script>

</body>
</html>
